//
//  Main_call.c
//  ShivaKumarChikkala
//
//  Created by Midathala Harish on 11.10.21.
//
#include <math.h>
#include "Main_call.h"
#include "ReadWave.h"
#include "VAD.h"
#include "adaptive_crossover.h"

const double Filter_ba[][FTAP_LEN] = {{0.072231,0.144462,0.072231},
{1.0000,-1.1092,0.3982},
{0.6268,-1.2537,0.6268},
{1.0000,-1.1092,0.3982}};

/* [80Hz,1500Hz] Bpf */
const double BPF_80Hz_1500Hz[][FTAP_LEN] = {{0.007617,0,-0.085260},
{1.0000,-1.8276,0.8295}};

const double hann_window[] =
{    0,
0.0000,
0.0002,
0.0003,
0.0006,
0.0009,
0.0014,
0.0018,
0.0024,
0.0030,
0.0038,
0.0045,
0.0054,
0.0063,
0.0074,
0.0084,
0.0096,
0.0108,
0.0121,
0.0135,
0.0150,
0.0165,
0.0181,
0.0198,
0.0215,
0.0233,
0.0252,
0.0272,
0.0292,
0.0313,
0.0335,
0.0357,
0.0381,
0.0404,
0.0429,
0.0454,
0.0480,
0.0507,
0.0534,
0.0562,
0.0590,
0.0620,
0.0650,
0.0680,
0.0711,
0.0743,
0.0776,
0.0809,
0.0843,
0.0877,
0.0912,
0.0948,
0.0984,
0.1021,
0.1058,
0.1096,
0.1135,
0.1174,
0.1214,
0.1254,
0.1295,
0.1337,
0.1379,
0.1421,
0.1464,
0.1508,
0.1552,
0.1597,
0.1642,
0.1688,
0.1734,
0.1781,
0.1828,
0.1876,
0.1924,
0.1972,
0.2022,
0.2071,
0.2121,
0.2171,
0.2222,
0.2273,
0.2325,
0.2377,
0.2429,
0.2482,
0.2536,
0.2589,
0.2643,
0.2697,
0.2752,
0.2807,
0.2862,
0.2918,
0.2974,
0.3030,
0.3087,
0.3143,
0.3201,
0.3258,
0.3316,
0.3373,
0.3432,
0.3490,
0.3549,
0.3607,
0.3666,
0.3726,
0.3785,
0.3845,
0.3904,
0.3964,
0.4025,
0.4085,
0.4145,
0.4206,
0.4266,
0.4327,
0.4388,
0.4449,
0.4510,
0.4571,
0.4632,
0.4693,
0.4755,
0.4816,
0.4877,
0.4939,
0.5000,
0.5061,
0.5123,
0.5184,
0.5245,
0.5307,
0.5368,
0.5429,
0.5490,
0.5551,
0.5612,
0.5673,
0.5734,
0.5794,
0.5855,
0.5915,
0.5975,
0.6036,
0.6096,
0.6155,
0.6215,
0.6274,
0.6334,
0.6393,
0.6451,
0.6510,
0.6568,
0.6627,
0.6684,
0.6742,
0.6799,
0.6857,
0.6913,
0.6970,
0.7026,
0.7082,
0.7138,
0.7193,
0.7248,
0.7303,
0.7357,
0.7411,
0.7464,
0.7518,
0.7571,
0.7623,
0.7675,
0.7727,
0.7778,
0.7829,
0.7879,
0.7929,
0.7978,
0.8028,
0.8076,
0.8124,
0.8172,
0.8219,
0.8266,
0.8312,
0.8358,
0.8403,
0.8448,
0.8492,
0.8536,
0.8579,
0.8621,
0.8663,
0.8705,
0.8746,
0.8786,
0.8826,
0.8865,
0.8904,
0.8942,
0.8979,
0.9016,
0.9052,
0.9088,
0.9123,
0.9157,
0.9191,
0.9224,
0.9257,
0.9289,
0.9320,
0.9350,
0.9380,
0.9410,
0.9438,
0.9466,
0.9493,
0.9520,
0.9546,
0.9571,
0.9596,
0.9619,
0.9643,
0.9665,
0.9687,
0.9708,
0.9728,
0.9748,
0.9767,
0.9785,
0.9802,
0.9819,
0.9835,
0.9850,
0.9865,
0.9879,
0.9892,
0.9904,
0.9916,
0.9926,
0.9937,
0.9946,
0.9955,
0.9962,
0.9970,
0.9976,
0.9982,
0.9986,
0.9991,
0.9994,
0.9997,
0.9998,
1.0000,
1.0000,
1.0000,
0.9998,
0.9997,
0.9994,
0.9991,
0.9986,
0.9982,
0.9976,
0.9970,
0.9962,
0.9955,
0.9946,
0.9937,
0.9926,
0.9916,
0.9904,
0.9892,
0.9879,
0.9865,
0.9850,
0.9835,
0.9819,
0.9802,
0.9785,
0.9767,
0.9748,
0.9728,
0.9708,
0.9687,
0.9665,
0.9643,
0.9619,
0.9596,
0.9571,
0.9546,
0.9520,
0.9493,
0.9466,
0.9438,
0.9410,
0.9380,
0.9350,
0.9320,
0.9289,
0.9257,
0.9224,
0.9191,
0.9157,
0.9123,
0.9088,
0.9052,
0.9016,
0.8979,
0.8942,
0.8904,
0.8865,
0.8826,
0.8786,
0.8746,
0.8705,
0.8663,
0.8621,
0.8579,
0.8536,
0.8492,
0.8448,
0.8403,
0.8358,
0.8312,
0.8266,
0.8219,
0.8172,
0.8124,
0.8076,
0.8028,
0.7978,
0.7929,
0.7879,
0.7829,
0.7778,
0.7727,
0.7675,
0.7623,
0.7571,
0.7518,
0.7464,
0.7411,
0.7357,
0.7303,
0.7248,
0.7193,
0.7138,
0.7082,
0.7026,
0.6970,
0.6913,
0.6857,
0.6799,
0.6742,
0.6684,
0.6627,
0.6568,
0.6510,
0.6451,
0.6393,
0.6334,
0.6274,
0.6215,
0.6155,
0.6096,
0.6036,
0.5975,
0.5915,
0.5855,
0.5794,
0.5734,
0.5673,
0.5612,
0.5551,
0.5490,
0.5429,
0.5368,
0.5307,
0.5245,
0.5184,
0.5123,
0.5061,
0.5000,
0.4939,
0.4877,
0.4816,
0.4755,
0.4693,
0.4632,
0.4571,
0.4510,
0.4449,
0.4388,
0.4327,
0.4266,
0.4206,
0.4145,
0.4085,
0.4025,
0.3964,
0.3904,
0.3845,
0.3785,
0.3726,
0.3666,
0.3607,
0.3549,
0.3490,
0.3432,
0.3373,
0.3316,
0.3258,
0.3201,
0.3143,
0.3087,
0.3030,
0.2974,
0.2918,
0.2862,
0.2807,
0.2752,
0.2697,
0.2643,
0.2589,
0.2536,
0.2482,
0.2429,
0.2377,
0.2325,
0.2273,
0.2222,
0.2171,
0.2121,
0.2071,
0.2022,
0.1972,
0.1924,
0.1876,
0.1828,
0.1781,
0.1734,
0.1688,
0.1642,
0.1597,
0.1552,
0.1508,
0.1464,
0.1421,
0.1379,
0.1337,
0.1295,
0.1254,
0.1214,
0.1174,
0.1135,
0.1096,
0.1058,
0.1021,
0.0984,
0.0948,
0.0912,
0.0877,
0.0843,
0.0809,
0.0776,
0.0743,
0.0711,
0.0680,
0.0650,
0.0620,
0.0590,
0.0562,
0.0534,
0.0507,
0.0480,
0.0454,
0.0429,
0.0404,
0.0381,
0.0357,
0.0335,
0.0313,
0.0292,
0.0272,
0.0252,
0.0233,
0.0215,
0.0198,
0.0181,
0.0165,
0.0150,
0.0135,
0.0121,
0.0108,
0.0096,
0.0084,
0.0074,
0.0063,
0.0054,
0.0045,
0.0038,
0.0030,
0.0024,
0.0018,
0.0014,
0.0009,
0.0006,
0.0003,
0.0002,
0.0000};
int CutOff_Freq[] = {80,315,630,1250,2500,5000};

int main(int argc, const char * argv[])
{
    /* %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
     %    variables declaration
     %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% */
    
    //BPF Filter
    BQF BPF80Hz15KHZ_Filter;
    
    //File Var
    uint32_t i=0,m=0;
    uint32_t samplelength=0;
    uint32_t Fs =48000;
    char *infileName = "/Users/harry/Desktop/PyLearn/Dev/WindNoiseSupress/ShivaKumarChikkala/ShivaKumarChikkala/OTOG2_Speech_silent_wind3_wind5_FanB_mic7.wav";
//    char *outfileName = "/Users/harry/Desktop/PyLearn/Dev/WindNoiseSupress/ShivaKumarChikkala/ShivaKumarChikkala/out.wav";
    
    int16_t *samples;
    int16_t *x_vpu_filtered_l;
    int16_t *x_vpu_filtered_r;
    
    //
    uint16_t nooverlap = 256U;
    const double *Win = hann_window;
    uint16_t Win_len = (uint16_t) (sizeof(hann_window)/sizeof(double));
    uint16_t nhop  = Win_len-nooverlap;
 
    
    float vad_threshold = 2e-5;
    float tA = 1/Fs*0.01;
    float E =0;
    float exp_avg_r =0;
    int Wn =0;
    /*LoadFilter PArams*/
    
    BPF80Hz15KHZ_Filter.type = 0; //Check Enum
    
    for(i=0;i<FTAP_LEN;i++)
    {
        BPF80Hz15KHZ_Filter.lpf_b[i]= BPF_80Hz_1500Hz[0][i];
        BPF80Hz15KHZ_Filter.lpf_a[i]= BPF_80Hz_1500Hz[1][i];
    }
    BPF80Hz15KHZ_Filter.lz1 = BPF80Hz15KHZ_Filter.lz2 = 0.0;
    BPF80Hz15KHZ_Filter.hz1 = BPF80Hz15KHZ_Filter.hz2 = 0.0;
    
    /* %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %    Read input
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% */
    
    wavread(infileName, &samples, &samplelength);
    uint32_t nx = samplelength;
    uint32_t nframes = (uint32_t)((nx-Win_len)/nhop);
    x_vpu_filtered_l = (int16_t *)malloc(samplelength);
    x_vpu_filtered_r = (int16_t *)malloc(samplelength);
    
    memset(x_vpu_filtered_l, 0, samplelength*sizeof(int16_t));
    memset(x_vpu_filtered_r, 0, samplelength*sizeof(int16_t));
    memcpy(x_vpu_filtered_r, x_vpu_filtered_l, samplelength*sizeof(int16_t));
    
    /* %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
     %    pre treat vpu signal with BPF
     %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% */
    
    for(i=0;i<samplelength;i++)
    {
        *(x_vpu_filtered_l+i) = processlpf(&BPF80Hz15KHZ_Filter, *(samples+i));
    }
    printf("framestart = %d\n",nframes);
    //    wavwrite(outfileName, x_vpu_filtered);
    
    for(m=0;m<(nframes-1);m++)
    {
        int16_t curretframe_VAD[512] = {0}; //assuming frame lenght is 512
        uint32_t startframeAt = m*nhop;
        printf("framestart = %d\n",startframeAt);
        //--------------------------------------------------------------------------
        //                     VAD
        //--------------------------------------------------------------------------
        VAD((x_vpu_filtered_l + startframeAt), E, tA, Win_len, nhop, vad_threshold,curretframe_VAD);
        //--------------------------------------------------------------------------
        //           Adaptive crossover frequencies
        //--------------------------------------------------------------------------
        adaptive_crossover((x_vpu_filtered_l + startframeAt), (x_vpu_filtered_r + startframeAt), CutOff_Freq, Fs, exp_avg_r, curretframe_VAD, Win_len, Win, &Wn);
    }
    
    
    free(samples);
    free(x_vpu_filtered_l);
    free(x_vpu_filtered_r);
    return 0;
}

